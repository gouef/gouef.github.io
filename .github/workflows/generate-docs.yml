name: Generate Documentation from All Repositories

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Můžete ručně spustit workflow

jobs:
  generate-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Get list of repositories
        id: repos
        run: |
          # Získání seznamu repozitářů v organizaci
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/orgs/${{ github.repository_owner }}/repos?per_page=100" | jq -r '.[].full_name' > repos.txt

      - name: Clone repositories and copy docs
        run: |
          # Vytvoření složky pro shromažďování dokumentace
          mkdir -p ./docs
          CURRENT_REPO="${{ github.repository }}"
          
          while IFS= read -r repo; do
            if [[ "$repo" == "$CURRENT_REPO" ]]; then
              echo "Přeskakuji aktuální repozitář: $repo"
              continue
            fi
          
            echo "Klonuji repozitář: $repo"
            git clone https://github.com/$repo.git
            REPO_NAME=$(basename $repo)
          
            mkdir -p ./docs/$REPO_NAME
            cp $REPO_NAME/README.md ./docs/$REPO_NAME/README.md
          
            # Pokud repozitář obsahuje složku docs, zkopírujte markdown soubory
            if [ -d "$REPO_NAME/docs" ]; then
              echo "Nalezená složka docs v repozitáři: $repo"
          
              if compgen -G "$REPO_NAME/docs/*.md" > /dev/null; then
                cp $REPO_NAME/docs/*.md ./docs/$REPO_NAME/
              else
                echo "Žádné Markdown soubory nenalezeny ve složce docs v repozitáři: $repo"
              fi
          
            else
              echo "Složka docs nenalezena v repozitáři: $repo"
            fi
            rm -rf $repo  # Odstraní repozitář po zpracování
  
  
            repo_name=$(basename $repo)
            echo "[$repo_name](./$repo_name/)" >> ./docs/index.md
          done < repos.txt
      - name: Generate _data/repos.yml
        run: |
          mkdir -p _data
          echo "" > _data/repos.yml

          for repo in ./docs/*; do
            if [ -d "$repo" ]; then
              repo_name=$(basename "$repo")
              echo "- name: $repo_name" >> _data/repos.yml
              echo "  sections:" >> _data/repos.yml
              for file in "$repo"/*.md; do
                if [ -f "$file" ]; then
                  section_name=$(basename "$file" .md | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g')
                  section_link="/$repo_name/$(basename "$file" .md)"
                  echo "    - title: $section_name" >> _data/repos.yml
                  echo "      link: $section_link" >> _data/repos.yml
                fi
              done
            fi
          done
      - name: Commit and push changes
        run: |
          if git diff --quiet ./docs; then
            echo "Žádné změny v docs, nic k commitování."
          else
            git add ./docs
            git add ./docs/**/*.*
            git commit -m "[Update] Automate update documentation"
            git push origin HEAD:main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Deploy Documentation to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages  # Cílová větev pro GitHub Pages
          folder: docs      # Adresář obsahující generovanou dokumentaci
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub token pro autentizaci
