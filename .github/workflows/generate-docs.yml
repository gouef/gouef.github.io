name: Generate Documentation from All Repositories

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Můžete ručně spustit workflow

jobs:
  generate-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Get list of repositories
        id: repos
        run: |
          # Získání seznamu repozitářů v organizaci
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/orgs/${{ github.repository_owner }}/repos?per_page=100" | jq -r '.[].full_name' > repos.txt

      - name: Clone repositories and copy docs
        run: |
          # Vytvoření složky pro shromažďování dokumentace
          mkdir -p ./docs
          CURRENT_REPO="${{ github.repository }}"
          
          while IFS= read -r repo; do
            if [[ "$repo" == "$CURRENT_REPO" ]]; then
              echo "Přeskakuji aktuální repozitář: $repo"
              continue
            fi
          
            echo "Klonuji repozitář: $repo"
            git clone https://github.com/$repo.git
            REPO_NAME=$(basename $repo)
          
            mkdir -p ./docs/$REPO_NAME
            cp $REPO_NAME/README.md ./docs/$REPO_NAME/README.md
          
            # Pokud repozitář obsahuje složku docs, zkopírujte markdown soubory
            if [ -d "$REPO_NAME/docs" ]; then
              echo "Nalezená složka docs v repozitáři: $repo"
              cp $REPO_NAME/docs/*.md ./docs/$REPO_NAME/
          
            else
              echo "Složka docs nenalezena v repozitáři: $repo"
            fi
            rm -rf $repo  # Odstraní repozitář po zpracování
          done < repos.txt

      - name: Commit and push changes
        run: |
          git add ./docs
          git commit -m "[Update] Automate update documentation"
          git push origin HEAD:main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Deploy Documentation to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages  # Cílová větev pro GitHub Pages
          folder: docs      # Adresář obsahující generovanou dokumentaci
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub token pro autentizaci
